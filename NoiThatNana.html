<!DOCTYPE html>
<html lang="vi" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nana Nội thất</title>
    <link rel="shortcut icon" href="logo.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js"></script>
    <style>
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-dot.selected {
            transform: scale(1.2);
            box-shadow: 0 0 0 2px #3B82F6;
        }

        /* Thêm vào phần <style> */
        .modal-fullscreen {
            max-width: none !important;
            width: 95vw !important;
            height: 95vh !important;
            margin: 2.5vh auto !important;
        }

        .modal-content {
            height: calc(100% - 2rem);
            overflow-y: auto;
        }

        .modal-image {
            max-height: 70vh;
            object-fit: contain;
            width: 100%;
        }

        .table-container {
            max-height: calc(95vh - 500px);
            overflow-y: auto;
        }

        .tag-badge {
            transition: all 0.2s;
        }

        .tag-badge:hover {
            transform: translateY(-1px);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen" x-data="{ 
    mobileMenuOpen: false,
    darkMode: localStorage.getItem('darkMode') === 'true',
    toggleDarkMode() {
        this.darkMode = !this.darkMode;
        localStorage.setItem('darkMode', this.darkMode);
        document.documentElement.classList.toggle('dark');
    }
}" :class="{ 'dark': darkMode }">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl animate-pulse">
            <div class="flex items-center space-x-4">
                <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="text-lg font-medium text-gray-900 dark:text-white">Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav
        class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40 backdrop-blur-lg bg-opacity-80">
        <div class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="#" class="flex items-center space-x-3">
                        <img class="h-10 w-auto" src="logo.png" alt="Nana Nội Thất">

                    </a>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="refreshData"
                        class="relative inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-all duration-200 group">
                        <svg class="w-5 h-5 mr-2 transform group-hover:rotate-180 transition-transform duration-300"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span>Làm mới</span>
                        <!-- Loading spinner - ẩn mặc định -->
                        <span id="refreshSpinner"
                            class="absolute inset-0 flex items-center justify-center bg-primary-600 rounded-lg hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </span>
                    </button>
                    <button @click="toggleDarkMode"
                        class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors duration-200">
                        <svg x-show="!darkMode" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <svg x-show="darkMode" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:w-1/5">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden sticky top-24">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Bộ lọc tìm kiếm</h3>
                            <button id="resetFilters" onclick="resetFilters()"
                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                <span>Đặt lại bộ lọc</span>
                            </button>
                        </div>
                        <!-- Search Input -->
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Tìm kiếm sản phẩm
                                </label>
                                <div class="relative">
                                    <input type="text" id="searchInput"
                                        class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors duration-200"
                                        placeholder="Nhập tên hoặc mã sản phẩm...">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Price Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Khoảng giá
                                </label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <input type="number" id="minPrice"
                                            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors duration-200"
                                            placeholder="Giá thấp nhất">
                                    </div>
                                    <div>
                                        <input type="number" id="maxPrice"
                                            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors duration-200"
                                            placeholder="Giá cao nhất">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    FOLDER
                                </label>
                                <div id="folderTags" class="flex flex-wrap gap-2">
                                    <!-- Tags will be inserted here -->
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                 Nhóm hệ
                                </label>
                                <div id="configTags" class="flex flex-wrap gap-2">
                                    <!-- Tags will be inserted here -->
                                </div>
                            </div>

                            <!-- Folder Tags -->
                         


                            <!-- Reset Button -->
                         
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="lg:w-4/5">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <!-- Pagination -->
                    <div id="pagination" class="mb-6">
                        <!-- Pagination will be inserted here -->
                    </div>

                    <!-- Products Container -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productsContainer">
                        <!-- Product cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Modal Liên hệ -->
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Liên hệ đặt hàng</h3>
                    <button
                        class="modal-close text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="contactForm" class="space-y-4">
                    <input type="hidden" id="contactProductCode" name="productCode">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Số điện thoại *
                        </label>
                        <input type="tel" id="contactPhone" required
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Ghi chú
                        </label>
                        <textarea id="contactNote" rows="3"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"></textarea>
                    </div>
                    <button type="submit"
                        class="w-full px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors duration-200">
                        Gửi yêu cầu
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Chi tiết -->
    <!-- Modal Chi tiết -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-7xl mx-4 transform transition-all duration-300 scale-95 opacity-0">
            <div class="p-6 modal-content">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Chi tiết hệ</h3>
                    <button
                        class="modal-close text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="productDetails" class="space-y-4">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // Constants and Globals
        const appId = 'd3755e47-c036-4240-ae62-1f73f8f765e5';
        const accessKey = 'V2-Q0yDm-HLXef-NJM6h-Oh4DH-TstFH-WqX7z-b8vMO-Q7Kv4';
        const region = 'www';
        let selectedCategories = new Set();
        let selectedFolders = new Set();
        let selectedConfigs = new Set();
        // Thêm biến cho phân trang
        // Constants for pagination
        const PAGE_SIZES = [6, 12, 24, 48, 96];
        let ITEMS_PER_PAGE = 12;
        let currentPage = 1;
        let filteredData = [];
        let allProducts = []; // Dữ liệu từ bảng DMHH
        let allProductDetails = []; // Dữ liệu từ bảng Danh sach SPHE
        let data = [];
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        function parseList(str) {
            if (!str) return [];
            return str.split(',').map(item => item.trim());
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        // Hàm tính toán số trang
        // Update other related functions
        function calculateTotalPages(items) {
            return Math.ceil(items.length / ITEMS_PER_PAGE);
        }

        // Function to create page size selector
        function createPageSizeSelector() {
            const container = document.createElement('div');
            container.className = 'flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300';

            container.innerHTML = `
        <span>Hiển thị:</span>
        <select id="pageSizeSelect" class="rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700">
            ${PAGE_SIZES.map(size => `
                <option value="${size}" ${size === ITEMS_PER_PAGE ? 'selected' : ''}>
                    ${size}
                </option>
            `).join('')}
        </select>
        <span>sản phẩm mỗi trang</span>
    `;

            return container;
        }
        // Function to calculate visible page range
        function getVisiblePageRange(currentPage, totalPages) {
            const delta = 2; // Number of pages to show before and after current page
            const range = [];

            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || // First page
                    i === totalPages || // Last page
                    (i >= currentPage - delta && i <= currentPage + delta) // Pages around current
                ) {
                    range.push(i);
                } else if (range[range.length - 1] !== '...') {
                    range.push('...');
                }
            }

            return range;
        }
        // Hàm tạo phân trang
        // Updated createPagination function
        function createPagination(totalPages) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg';

            // Page size selector with modern styling
            const pageSizeWrapper = document.createElement('div');
            pageSizeWrapper.className = 'flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300';
            pageSizeWrapper.innerHTML = `
                <span>Hiển thị:</span>
                <select id="pageSizeSelect" class="rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors duration-200">
                    ${PAGE_SIZES.map(size => `
                        <option value="${size}" ${size === ITEMS_PER_PAGE ? 'selected' : ''}>
                            ${size}
                        </option>
                    `).join('')}
                </select>
                <span>sản phẩm mỗi trang</span>
            `;

            // Pagination controls
            const controls = document.createElement('div');
            controls.className = 'flex items-center space-x-2';

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = `px-4 py-2 rounded-lg ${currentPage === 1 ?
                'bg-gray-200 text-gray-400 cursor-not-allowed dark:bg-gray-600 dark:text-gray-500' :
                'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600'} transition-colors duration-200`;
            prevButton.disabled = currentPage === 1;
            prevButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            `;
            if (currentPage !== 1) {
                prevButton.addEventListener('click', () => goToPage(currentPage - 1));
            }

            // Page numbers
            const pageNumbers = getVisiblePageRange(currentPage, totalPages);
            const pageButtons = pageNumbers.map(pageNum => {
                if (pageNum === '...') {
                    const span = document.createElement('span');
                    span.className = 'px-4 py-2 text-gray-700 dark:text-gray-300';
                    span.textContent = '...';
                    return span;
                }

                const button = document.createElement('button');
                button.className = `px-4 py-2 rounded-lg ${currentPage === pageNum ?
                    'bg-primary-600 text-white' :
                    'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600'} transition-colors duration-200`;
                button.textContent = pageNum;
                button.addEventListener('click', () => goToPage(pageNum));
                return button;
            });

            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = `px-4 py-2 rounded-lg ${currentPage === totalPages ?
                'bg-gray-200 text-gray-400 cursor-not-allowed dark:bg-gray-600 dark:text-gray-500' :
                'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600'} transition-colors duration-200`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            `;
            if (currentPage !== totalPages) {
                nextButton.addEventListener('click', () => goToPage(currentPage + 1));
            }

            // Assemble pagination controls
            controls.appendChild(prevButton);
            pageButtons.forEach(button => controls.appendChild(button));
            controls.appendChild(nextButton);

            // Results counter
            const resultsInfo = document.createElement('div');
            resultsInfo.className = 'text-sm text-gray-700 dark:text-gray-300';
            const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(currentPage * ITEMS_PER_PAGE, filteredData.length);
            resultsInfo.textContent = `Hiển thị ${startItem}-${endItem} trong số ${filteredData.length} sản phẩm`;

            wrapper.appendChild(pageSizeWrapper);
            wrapper.appendChild(controls);
            wrapper.appendChild(resultsInfo);
            paginationContainer.appendChild(wrapper);

            // Add event listener for page size selector
            document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
                ITEMS_PER_PAGE = parseInt(e.target.value);
                currentPage = 1;
                renderProducts(filteredData);
            });
        }

        // Initialize dark mode on page load
        document.addEventListener('DOMContentLoaded', () => {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.documentElement.classList.add('dark');
            }
            init();
        });
        // Hàm chuyển trang
        function goToPage(page) {
            currentPage = page;
            renderProducts(filteredData);
        }
        // Utility functions
        const formatCurrency = amount => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const formatDate = dateString => {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        function renderProducts(products) {
            filteredData = products;
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';

            const totalPages = calculateTotalPages(products);
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = Math.min(start + ITEMS_PER_PAGE, products.length);
            const paginatedProducts = products.slice(start, end);

            paginatedProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 animate-fade-in';

                card.innerHTML = `
            <div class="aspect-w-16 aspect-h-9 relative overflow-hidden group">
                <img data-src="${product['HÌNH ẢNH']}" 
                     alt="${product['TÊN HỆ']}"
                     class="w-full h-64 object-cover lazy transform group-hover:scale-110 transition-transform duration-500"
                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity duration-300"></div>
            </div>
            <div class="p-6 space-y-3">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white line-clamp-2 hover:line-clamp-none transition-all duration-200">
                    ${product['TÊN HỆ']}
                </h3>
                <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                    </svg>
                    <span>Mã: ${product['MÃ HH']}</span>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    <span>${product['CẤU HÌNH HỆ']}</span>
                </div>
                <div class="flex gap-3 mt-4">
                    <button class="detail-btn flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Chi tiết
                    </button>
                </div>
            </div>
        `;

                const detailBtn = card.querySelector('.detail-btn');
                detailBtn.addEventListener('click', () => openDetailModal(product));

                container.appendChild(card);
            });

            createPagination(totalPages);
            initLazyLoading();
        }
        // Hàm khởi tạo lazy loading
        function initLazyLoading() {
            const lazyImages = document.querySelectorAll('img.lazy');

            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });

            lazyImages.forEach(img => imageObserver.observe(img));
        }

        // Hàm format số
        function formatNumber(number) {
            return number ? number.toLocaleString('vi-VN') : '0';
        }

        // Sửa lại hàm openDetailModal để sử dụng dữ liệu từ biến toàn cục
        function openDetailModal(product) {
            const modal = document.getElementById('detailModal');
            const detailsContainer = document.getElementById('productDetails');
            modal.querySelector('div:first-child').classList.add('modal-fullscreen');

            // Lọc sản phẩm chi tiết từ biến toàn cục
            const productDetails = allProductDetails.filter(detail => detail['Mã hệ'] === product['MÃ HH']);

            detailsContainer.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="aspect-w-16 aspect-h-9">
                <img src="${product['HÌNH ẢNH']}" alt="${product['TÊN HỆ']}" 
                     class="modal-image rounded-lg shadow-lg">
            </div>
            <div class="space-y-4">
                <h4 class="text-2xl font-semibold text-gray-900 dark:text-white">
                    ${product['TÊN HỆ']}
                </h4>
                <div class="space-y-2">
                    <p class="text-lg text-gray-600 dark:text-gray-400">
                        Mã: ${product['MÃ HH']}
                    </p>
                    <p class="text-lg text-gray-600 dark:text-gray-400">
                        Cấu hình: ${product['CẤU HÌNH HỆ']}
                    </p>
                </div>
                ${product['Chi tiết hệ'] ? `
                    <div>
                        <h4 class="text-xl font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Chi tiết hệ:
                        </h4>
                        <p class="text-lg text-gray-600 dark:text-gray-400 whitespace-pre-line">
                            ${product['Chi tiết hệ']}
                        </p>
                    </div>
                ` : ''}
                   <div class="mt-6">
            <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                Danh sách sản phẩm trong hệ
            </h4>
            <div class="table-container overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Mã SP</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">FOLDER</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tên sản phẩm</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Các loại VL</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">T.Kế</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Chi tiết SP</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ĐVT</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Kích thước (D×R×C)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">KL Đơn vị</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nhân bản SP</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Đơn giá</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                        ${productDetails.map(detail => `
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['Mã sản phẩm'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['FOLDER'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['TÊN SẢN PHẨM'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['CÁC LOẠI VL'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['T.KẾ'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['CHI TIẾT SP'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['ĐVT'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                    ${detail['DÀI P'] || '-'}×${detail['SÂU P'] || '-'}×${detail['CAO P'] || '-'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['KL ĐƠN VỊ'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${detail['NHÂN BẢN SP'] || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formatCurrency(detail['ĐƠN GIÁ'])}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formatCurrency(detail['THÀNH TIỀN'])}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <td colspan="11" class="px-6 py-3 text-right text-sm font-medium text-gray-500 dark:text-gray-300">
                                Tổng cộng:
                            </td>
                            <td class="px-6 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-100">
                                ${formatCurrency(productDetails.reduce((sum, detail) => sum + (detail['THÀNH TIỀN'] || 0), 0))}
                            </td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
            </div>
        </div>

     
    `;

            // Thêm event listener cho hình ảnh để zoom
            const modalImage = detailsContainer.querySelector('.modal-image');
            modalImage.addEventListener('click', () => {
                modalImage.classList.toggle('cursor-zoom-out');
                modalImage.classList.toggle('fixed');
                modalImage.classList.toggle('inset-0');
                modalImage.classList.toggle('z-50');
                modalImage.classList.toggle('p-4');
                modalImage.classList.toggle('bg-black');
                modalImage.classList.toggle('bg-opacity-75');
            });

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div:first-child').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
     
     
     
        // Thêm event listeners cho form liên hệ
        document.getElementById('contactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                'NGÀY CHĂM SÓC': new Date().toISOString(),
                'SẢN PHẨM QUAN TÂM': document.getElementById('contactProductCode').value,
                'SĐT': document.getElementById('contactPhone').value,
                'GHI CHÚ NHU CẦU': document.getElementById('contactNote').value || '',
                'LOẠI CHĂM SÓC': "Tư vấn bán hàng"
            };

            try {
                // Gọi API để lưu dữ liệu
                closeModal('contactModal');
                await saveContactRequest(formData);

                showToast('Đã gửi yêu cầu thành công!', 'success');
                document.getElementById('contactForm').reset();
            } catch (error) {
                showToast('Không thể gửi yêu cầu. Vui lòng thử lại!', 'error');
            }
        });

        // Thêm event listeners cho nút đóng modal
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('[id$="Modal"]');
                closeModal(modal.id);
            });
        });

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.querySelector('div:first-child').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Đóng modal khi click outside
        document.querySelectorAll('[id$="Modal"]').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });
        async function saveContactRequest(data) {
            console.log(data);

            // Gọi API của bạn để lưu dữ liệu
            const response = await apiRequest('CSKH', 'Add', {
                Rows: [data]
            }, {
                Properties: {
                }
            });
            return response;
        }
        function openContactModal(product) {
            const modal = document.getElementById('contactModal');
            document.getElementById('contactProductCode').value = product['MÃ HH'];
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div:first-child').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        
        function initializeFilters() {
    // Lấy danh sách unique các giá trị
    const configs = [...new Set(data.map(item => item['CẤU HÌNH HỆ']))].sort();
    const folders = [...new Set(allProductDetails.map(item => item['FOLDER']))].filter(Boolean).sort();

    // Khởi tạo config tags
    const configTagsContainer = document.getElementById('configTags');
    configTagsContainer.innerHTML = '';
    configs.forEach(config => {
        const tag = document.createElement('button');
        tag.className = `px-3 py-1 rounded-full text-sm font-medium border transition-all duration-200
            ${selectedConfigs.has(config) 
                ? 'bg-primary-100 text-primary-800 border-primary-200 dark:bg-primary-900 dark:text-primary-200 dark:border-primary-700' 
                : 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600'} 
            hover:shadow-md`;
        tag.textContent = config;
        tag.addEventListener('click', () => {
            tag.classList.toggle('bg-primary-100');
            tag.classList.toggle('text-primary-800');
            tag.classList.toggle('border-primary-200');
            tag.classList.toggle('dark:bg-primary-900');
            tag.classList.toggle('dark:text-primary-200');
            tag.classList.toggle('dark:border-primary-700');
            if (selectedConfigs.has(config)) {
                selectedConfigs.delete(config);
            } else {
                selectedConfigs.add(config);
            }
            filterProducts();
        });
        configTagsContainer.appendChild(tag);
    });

    // Khởi tạo folder tags
    const folderTagsContainer = document.getElementById('folderTags');
    folderTagsContainer.innerHTML = '';
    folders.forEach(folder => {
        const tag = document.createElement('button');
        tag.className = `px-3 py-1 rounded-full text-sm font-medium border transition-all duration-200
            ${selectedFolders.has(folder) 
                ? 'bg-primary-100 text-primary-800 border-primary-200 dark:bg-primary-900 dark:text-primary-200 dark:border-primary-700' 
                : 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600'} 
            hover:shadow-md`;
        tag.textContent = folder;
        tag.addEventListener('click', () => {
            tag.classList.toggle('bg-primary-100');
            tag.classList.toggle('text-primary-800');
            tag.classList.toggle('border-primary-200');
            tag.classList.toggle('dark:bg-primary-900');
            tag.classList.toggle('dark:text-primary-200');
            tag.classList.toggle('dark:border-primary-700');
            if (selectedFolders.has(folder)) {
                selectedFolders.delete(folder);
            } else {
                selectedFolders.add(folder);
            }
            filterProducts();
        });
        folderTagsContainer.appendChild(tag);
    });
}

function resetFilters() {
    // Reset search
    document.getElementById('searchInput').value = '';

    // Reset configs
    selectedConfigs.clear();
    document.querySelectorAll('#configTags button').forEach(tag => {
        tag.classList.remove('bg-primary-100', 'text-primary-800', 'border-primary-200', 
            'dark:bg-primary-900', 'dark:text-primary-200', 'dark:border-primary-700');
    });

    // Reset folders
    selectedFolders.clear();
    document.querySelectorAll('#folderTags button').forEach(tag => {
        tag.classList.remove('bg-primary-100', 'text-primary-800', 'border-primary-200', 
            'dark:bg-primary-900', 'dark:text-primary-200', 'dark:border-primary-700');
    });

    filterProducts();
}
        // Hàm chuyển đổi từ có dấu sang không dấu
        function removeVietnameseTones(str) {
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
            str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
            str = str.replace(/đ/g, "d");
            return str;
        }

        // Hàm tính điểm tương đồng giữa hai chuỗi
        function similarity(s1, s2) {
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) {
                longer = s2;
                shorter = s1;
            }
            const longerLength = longer.length;
            if (longerLength === 0) {
                return 1.0;
            }
            const distance = levenshteinDistance(longer, shorter);
            return (longerLength - distance) / parseFloat(longerLength);
        }

        // Hàm tính khoảng cách Levenshtein
        function levenshteinDistance(str1, str2) {
            const track = Array(str2.length + 1).fill(null).map(() =>
                Array(str1.length + 1).fill(null));
            for (let i = 0; i <= str1.length; i += 1) {
                track[0][i] = i;
            }
            for (let j = 0; j <= str2.length; j += 1) {
                track[j][0] = j;
            }
            for (let j = 1; j <= str2.length; j += 1) {
                for (let i = 1; i <= str1.length; i += 1) {
                    const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    track[j][i] = Math.min(
                        track[j][i - 1] + 1,
                        track[j - 1][i] + 1,
                        track[j - 1][i - 1] + indicator,
                    );
                }
            }
            return track[str2.length][str1.length];
        }
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'
                } text-white flex items-center space-x-2`;

            const icon = document.createElement('span');
            if (type === 'success') {
                icon.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M5 13l4 4L19 7" />
            </svg>`;
            } else {
                icon.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M6 18L18 6M6 6l12 12" />
            </svg>`;
            }

            const text = document.createElement('span');
            text.textContent = message;

            toast.appendChild(icon);
            toast.appendChild(text);
            document.body.appendChild(toast);

            // Animation
            requestAnimationFrame(() => {
                toast.style.transform = 'translateY(-1rem)';
                toast.style.opacity = '1';
            });

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateY(1rem)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Thêm biến để theo dõi trạng thái refresh
        let isRefreshing = false;

        // Hàm làm mới dữ liệu
        // Sửa lại hàm refreshData để cập nhật cả 2 bảng
        async function refreshData() {
            if (isRefreshing) return;

            const refreshButton = document.getElementById('refreshData');
            const refreshSpinner = document.getElementById('refreshSpinner');

            try {
                isRefreshing = true;
                refreshButton.disabled = true;
                refreshSpinner.classList.remove('hidden');

                // Lấy dữ liệu mới từ cả 2 bảng
                const [newProducts, newProductDetails] = await Promise.all([
                    fetchSanphamData(),
                    fetchAllProductDetails()
                ]);

                // Cập nhật biến toàn cục
                allProducts = newProducts;
                allProductDetails = newProductDetails;

                // Cập nhật dữ liệu và render lại
                data = allProducts;
                selectedCategories.clear();
                currentPage = 1;

                // Khởi tạo lại các bộ lọc với dữ liệu mới
                initializeFilters();
                renderProducts(data);

                showToast('Đã cập nhật dữ liệu thành công!', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Không thể cập nhật dữ liệu. Vui lòng thử lại!', 'error');
            } finally {
                isRefreshing = false;
                refreshButton.disabled = false;
                refreshSpinner.classList.add('hidden');
            }
        }

        // Thêm event listener cho nút refresh
        document.addEventListener('DOMContentLoaded', () => {
            const refreshButton = document.getElementById('refreshData');
            refreshButton.addEventListener('click', refreshData);
        });

        // Hàm lọc sản phẩm được tối ưu hóa
        // Cập nhật hàm filterProducts
        function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const searchTermNoTone = removeVietnameseTones(searchTerm);

    let filtered = data;

    // Lọc theo tìm kiếm
    if (searchTerm) {
        filtered = filtered.filter(product => {
            const productName = product['TÊN HỆ'].toLowerCase();
            const productNameNoTone = removeVietnameseTones(productName);
            const productCode = product['MÃ HH'].toLowerCase();
            
            // Tìm trong chi tiết sản phẩm
            const relatedProducts = allProductDetails.filter(detail => detail['Mã hệ'] === product['MÃ HH']);
            const matchInDetails = relatedProducts.some(detail => {
                const detailName = (detail['TÊN SẢN PHẨM'] || '').toLowerCase();
                const detailNameNoTone = removeVietnameseTones(detailName);
                return detailName.includes(searchTerm) || detailNameNoTone.includes(searchTermNoTone);
            });

            return productName.includes(searchTerm) ||
                productNameNoTone.includes(searchTermNoTone) ||
                productCode.includes(searchTerm) ||
                matchInDetails;
        });
    }

    // Lọc theo cấu hình hệ
    if (selectedConfigs.size > 0) {
        filtered = filtered.filter(product =>
            selectedConfigs.has(product['CẤU HÌNH HỆ'])
        );
    }

    // Lọc theo folder
    if (selectedFolders.size > 0) {
        filtered = filtered.filter(product => {
            const relatedProducts = allProductDetails.filter(detail => detail['Mã hệ'] === product['MÃ HH']);
            return relatedProducts.some(detail => selectedFolders.has(detail['FOLDER']));
        });
    }

    currentPage = 1;
    renderProducts(filtered);
}
        // Thêm debounce để tối ưu hiệu suất
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Áp dụng debounce cho hàm filterProducts
        const debouncedFilterProducts = debounce(filterProducts, 300);

        // Cập nhật event listener
        // Update existing event listeners
        document.getElementById('searchInput').addEventListener('input', debouncedFilterProducts);
        document.getElementById('minPrice').addEventListener('input', debouncedFilterProducts);
        document.getElementById('maxPrice').addEventListener('input', debouncedFilterProducts);
        // API request function
        async function apiRequest(tableName, action, data, Properties) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        ...Properties,
                        ...data
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // Fetch data from API
        async function fetchSanphamData() {
            try {
                const response = await apiRequest('DMHH', 'Find', {}, {
                    Properties: {
                        Selector: `Filter(DMHH, true)`,
                        UserSettings: {
                            "User name": "sep",
                            "Password": "22"
                        }
                    }
                });
                if (!Array.isArray(response) || response.length === 0) {
                    throw new Error("Invalid data received from API");
                }
                return response;
            } catch (error) {
                console.error("Error fetching data from AppSheet:", error);
                throw error;
            }
        }
        // Hàm lấy tất cả dữ liệu chi tiết sản phẩm
        async function fetchAllProductDetails() {
            try {
                const response = await apiRequest('Danh sach SPHE', 'Find', {}, {
                    Properties: {
                        Selector: `Filter( Danh sach SPHE ,true)`,
                        UserSettings: {
                            "User name": "sep",
                            "Password": "22"
                        }
                    }
                });
                return response;
            } catch (error) {
                console.error("Error fetching all product details:", error);
                throw error;
            }
        }
        // Initialize app
        async function init() {
            try {
                showLoading();
                // Lấy dữ liệu song song từ cả 2 bảng
                const [productsResponse, productDetailsResponse] = await Promise.all([
                    fetchSanphamData(),
                    fetchAllProductDetails()
                ]);

                // Lưu vào biến toàn cục
                allProducts = productsResponse;
                allProductDetails = productDetailsResponse;

                // Khởi tạo giao diện
                data = allProducts;
                initializeFilters();
                renderProducts(data);
            } catch (error) {
                console.error("Error initializing app:", error);
                showToast('Không thể tải dữ liệu. Vui lòng thử lại!', 'error');
            } finally {
                hideLoading();
            }
        }


        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
